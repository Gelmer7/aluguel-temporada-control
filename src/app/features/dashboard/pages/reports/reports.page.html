<div class="flex flex-col gap-2 p-2 overflow-auto max-h-[calc(100vh)]">
  <app-page-header [title]="'TERMS.REPORTS' | translate" icon="pi pi-chart-bar" />

  <!-- Resumo em Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
    @if (loading()) {
      @for (i of [1, 2, 3]; track i) {
        <p-card>
          <div class="flex flex-col gap-1">
            <p-skeleton width="40%" height="0.875rem" />
            <p-skeleton width="60%" height="1.5rem" />
          </div>
        </p-card>
      }
    } @else {
      <p-card>
        <ng-template pTemplate="subtitle">
          <i class="pi pi-arrow-up-right"></i> {{ 'REPORTS.GROSS' | translate }}:
          <span>{{ summary().totalGross | currency: 'BRL' }}</span>
        </ng-template>
        <div class="flex items-center gap-2"></div>
      </p-card>

      <p-card>
        <ng-template pTemplate="subtitle">
          <i class="pi pi-arrow-down-right"></i> {{ 'REPORTS.EXPENSES' | translate }}:
          <span>{{ summary().totalExpenses | currency: 'BRL' }}</span>
        </ng-template>
      </p-card>

      <p-card>
        <ng-template pTemplate="subtitle">
          <i class="pi pi-wallet"></i> {{ 'REPORTS.NET' | translate }}:
          <span>{{ summary().totalNet | currency: 'BRL' }}</span>
        </ng-template>
      </p-card>
    }
  </div>

  <!-- GrÃ¡fico e Filtros -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
    <p-card class="lg:col-span-3">
      <ng-template pTemplate="title">
        {{ 'REPORTS.CHART_TITLE' | translate }}
      </ng-template>
      <div class="h-64">
        @if (loading()) {
          <p-skeleton width="100%" height="100%" />
        } @else {
          <div echarts [options]="chartOptions()" class="w-full h-full"></div>
        }
      </div>
    </p-card>

    <p-card>
      <ng-template pTemplate="title">
        {{ 'MENU.HEADER' | translate }}
      </ng-template>
      <div class="flex flex-col gap-3">
        <div class="flex items-center gap-2">
          <p-checkbox
            [ngModel]="showGross()"
            (ngModelChange)="showGross.set($event)"
            [binary]="true"
            inputId="gross"
          />
          <label for="gross">{{ 'REPORTS.SHOW_GROSS' | translate }}</label>
        </div>
        <div class="flex items-center gap-2">
          <p-checkbox
            [ngModel]="showExpenses()"
            (ngModelChange)="showExpenses.set($event)"
            [binary]="true"
            inputId="expenses"
          />
          <label for="expenses">{{ 'REPORTS.SHOW_EXPENSES' | translate }}</label>
        </div>
        <div class="flex items-center gap-2">
          <p-checkbox
            [ngModel]="showNet()"
            (ngModelChange)="showNet.set($event)"
            [binary]="true"
            inputId="net"
          />
          <label for="net">{{ 'REPORTS.SHOW_NET' | translate }}</label>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Tabela de Detalhamento -->
  <p-card>
    <ng-template pTemplate="title">
      {{ 'REPORTS.DETAILS' | translate }}
    </ng-template>

    <div class="overflow-hidden border border-surface rounded-lg">
      <p-table
        [value]="flattenedData()"
        [loading]="loading()"
        sortField="year"
        sortMode="single"
        dataKey="year"
        rowGroupMode="subheader"
        groupRowsBy="year"
        [scrollable]="true"
        scrollHeight="500px"
        class="p-datatable-sm"
        [tableStyle]="{ 'min-width': '60rem' }"
      >
        <ng-template #header>
          <tr>
            <th style="width: 25%">{{ 'TERMS.MONTH' | translate }}</th>
            @if (showGross()) {
              <th style="width: 25%">{{ 'TERMS.GROSS' | translate }}</th>
            }
            @if (showExpenses()) {
              <th style="width: 25%">{{ 'TERMS.EXPENSES' | translate }}</th>
            }
            @if (showNet()) {
              <th style="width: 25%">{{ 'TERMS.NET' | translate }}</th>
            }
          </tr>
        </ng-template>

        <ng-template #groupheader let-item let-rowIndex="rowIndex" let-expanded="expanded">
          <tr class="bg-surface-50 dark:bg-surface-900">
            <td [attr.colspan]="colSpan()">
              <div class="flex items-center gap-2">
                <button
                  type="button"
                  pButton
                  pRipple
                  [pRowToggler]="item"
                  [text]="true"
                  [rounded]="true"
                  [plain]="true"
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                ></button>
                <span class="font-bold">{{ item.year }}</span>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #groupfooter let-item>
          <tr class="bg-surface-100/50 dark:bg-surface-800/50 font-bold">
            <td>{{ 'TERMS.TOTAL' | translate }} {{ item.year }}</td>
            @if (showGross()) {
              <td>{{ item.yearTotalGross | currency: 'BRL' }}</td>
            }
            @if (showExpenses()) {
              <td>{{ item.yearTotalExpenses | currency: 'BRL' }}</td>
            }
            @if (showNet()) {
              <td>{{ item.yearTotalNet | currency: 'BRL' }}</td>
            }
          </tr>
        </ng-template>

        <ng-template #expandedrow let-month let-i="rowIndex">
          <tr>
            <td>{{ 'MONTHS.' + month.monthIndex | translate }}</td>
            @if (showGross()) {
              <td>{{ month.gross | currency: 'BRL' }}</td>
            }
            @if (showExpenses()) {
              <td>{{ month.expenses | currency: 'BRL' }}</td>
            }
            @if (showNet()) {
              <td>{{ month.net | currency: 'BRL' }}</td>
            }
          </tr>
        </ng-template>
      </p-table>
    </div>
  </p-card>
</div>
