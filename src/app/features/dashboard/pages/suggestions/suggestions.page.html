<ng-template #headerActions>
  <div class="flex items-center gap-2">
    <p-button
      icon="pi pi-plus"
      severity="success"
      [size]="'small'"
      (click)="openNew()"
      [pTooltip]="'SUGGESTIONS_FORM.NEW' | translate"
    />
  </div>
</ng-template>

<div class="h-full flex flex-col p-2 bg-surface-50 dark:bg-surface-950 gap-2 overflow-hidden">
  <p-toast />
  <p-confirm-dialog />

  <app-filter-container>
    <ng-template #filterSummary>
      <span>{{ 'TERMS.YEAR' | translate }}: {{ getYearLabel() }}</span>
      <span>{{ 'TERMS.MONTH' | translate }}: {{ getMonthLabel() }}</span>
      <span>{{ 'TERMS.STATUS' | translate }}: {{ getStatusLabel() }}</span>
    </ng-template>

    <div class="flex flex-wrap items-center gap-2 w-full p-1">
      <p-floatLabel class="flex-1 min-w-[120px]" variant="in">
        <p-multiSelect
          [options]="yearOptions()"
          [(ngModel)]="selectedYear"
          optionLabel="label"
          optionValue="value"
          class="w-full"
          appendTo="body"
          [maxSelectedLabels]="1"
        >
          <ng-template pTemplate="selectedItems" let-selectedOptions>
            @if (selectedOptions && selectedOptions.length > 0) {
              @if (selectedOptions.length === yearOptions().length) {
                {{ 'TERMS.ALL' | translate }}
              } @else {
                {{ selectedOptions.length }} {{ 'TERMS.SELECTED' | translate }}
              }
            } @else {
              {{ 'TERMS.ALL' | translate }}
            }
          </ng-template>
          <ng-template pTemplate="item" let-option>
            {{ option.label | translate }}
          </ng-template>
        </p-multiSelect>
        <label>{{ 'TERMS.YEAR' | translate }}</label>
      </p-floatLabel>

      <p-floatLabel class="flex-1 min-w-[120px]" variant="in">
        <p-multiSelect
          [options]="monthOptions"
          [(ngModel)]="selectedMonth"
          optionLabel="label"
          optionValue="value"
          class="w-full"
          appendTo="body"
          [maxSelectedLabels]="2"
        >
          <ng-template pTemplate="selectedItems" let-selectedOptions>
            @if (selectedOptions && selectedOptions.length > 0) {
              @if (selectedOptions.length === monthOptions.length) {
                {{ 'TERMS.ALL' | translate }}
              } @else {
                {{ selectedOptions.length }} {{ 'TERMS.SELECTED' | translate }}
              }
            } @else {
              {{ 'TERMS.ALL' | translate }}
            }
          </ng-template>
          <ng-template pTemplate="item" let-option>
            {{ option.label | translate }}
          </ng-template>
        </p-multiSelect>
        <label>{{ 'TERMS.MONTH' | translate }}</label>
      </p-floatLabel>

      <p-floatLabel class="flex-1 min-w-[150px]" variant="in">
        <p-multiSelect
          [options]="statusOptions"
          [(ngModel)]="selectedStatus"
          optionLabel="label"
          optionValue="value"
          class="w-full"
          appendTo="body"
          [maxSelectedLabels]="2"
        >
          <ng-template pTemplate="selectedItems" let-selectedOptions>
            @if (selectedOptions && selectedOptions.length > 0) {
              @if (selectedOptions.length === statusOptions.length) {
                {{ 'TERMS.ALL' | translate }}
              } @else {
                {{ selectedOptions.length }} {{ 'TERMS.SELECTED' | translate }}
              }
            } @else {
              {{ 'TERMS.ALL' | translate }}
            }
          </ng-template>
          <ng-template pTemplate="item" let-option>
            {{ option.label | translate }}
          </ng-template>
        </p-multiSelect>
        <label>{{ 'TERMS.STATUS' | translate }}</label>
      </p-floatLabel>

      <p-button
        icon="pi pi-filter-slash"
        severity="secondary"
        [text]="true"
        (click)="clearFilters()"
        class="flex-shrink-0 !p-0"
      />
    </div>
  </app-filter-container>

  @if (loading()) {
    <div class="flex justify-center p-12">
      <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
    </div>
  } @else {
    @if (suggestions().length === 0) {
      <div
        class="text-center p-16 bg-white dark:bg-surface-900 rounded-xl border border-dashed border-surface-300 dark:border-surface-700"
      >
        <div class="flex flex-col items-center gap-4">
          <i class="pi pi-inbox text-6xl opacity-20"></i>
          <span class="text-xl font-medium opacity-60">{{
            'SUGGESTIONS_FORM.NO_DATA' | translate
          }}</span>
          <p-button
            [label]="'SUGGESTIONS_FORM.CREATE_FIRST' | translate"
            icon="pi pi-plus"
            (click)="openNew()"
            [text]="true"
          />
        </div>
      </div>
    } @else {
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto">
        @for (suggestion of suggestions(); track suggestion.id) {
          <div
            class="dark:bg-surface-900 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm hover:shadow-xl transition-all duration-300 flex flex-col h-full overflow-hidden group"
          >
            <!-- Card Header -->
            <div
              class="p-2 border-b border-surface-100 dark:border-surface-800 flex justify-between items-start gap-4"
            >
              <h2
                class="text-xl font-bold m-0 leading-snug text-surface-900 dark:text-surface-0 flex-1 line-clamp-2"
              >
                {{ suggestion.title }}
              </h2>
              <p-tag
                [value]="'SUGGESTIONS_FORM.STATUS.' + suggestion.status | translate"
                [severity]="getStatusSeverity(suggestion.status)"
                [rounded]="true"
                class="flex-shrink-0 shadow-sm"
              />
            </div>

            <!-- Card Content -->
            <div class="p-4 flex-1 flex flex-col gap-2">
              <div class="flex-1">
                <p
                  class="text-base text-surface-600 dark:text-surface-400 whitespace-pre-wrap leading-relaxed m-0"
                >
                  {{ suggestion.description }}
                </p>
              </div>

              @if (suggestion.answer) {
                <div
                  class="p-5 bg-primary-50/50 dark:bg-primary-900/10 rounded-xl border border-primary-100 dark:border-primary-900/30 relative overflow-hidden"
                >
                  <div class="absolute top-0 left-0 w-1 h-full bg-primary-500"></div>
                  <h3
                    class="text-xs font-black uppercase tracking-widest text-primary-600 dark:text-primary-400 mb-2 flex items-center gap-2"
                  >
                    <i class="pi pi-comment text-[10px]"></i>
                    {{ 'SUGGESTIONS_FORM.ANSWER' | translate }}
                  </h3>
                  <p
                    class="text-sm text-surface-700 dark:text-surface-300 italic whitespace-pre-wrap m-0 leading-relaxed"
                  >
                    {{ suggestion.answer }}
                  </p>
                </div>
              }
            </div>

            <!-- Card Footer -->
            <div class="p-2 border-t">
              <span
                class="text-xs font-medium text-surface-500 dark:text-surface-400 flex items-center gap-2"
              >
                <i class="pi pi-calendar text-[10px]"></i>
                {{ 'ACTIONS.CREATED_AT' | translate }}: {{ formatDate(suggestion.created_at) }}
              </span>

              <div class="flex items-center gap-1 justify-end">
                <p-button
                  icon="pi pi-pencil"
                  [text]="true"
                  severity="info"
                  (click)="openEdit(suggestion)"
                  [pTooltip]="'ACTIONS.EDIT' | translate"
                />
                <p-button
                  icon="pi pi-trash"
                  [text]="true"
                  severity="danger"
                  (click)="confirmDelete(suggestion)"
                  [pTooltip]="'ACTIONS.DELETE' | translate"
                />
              </div>
            </div>
          </div>
        }
      </div>
    }
  }
</div>

<app-suggestion-form
  [visible]="isFormVisible()"
  (visibleChange)="isFormVisible.set($event)"
  [suggestion]="selectedSuggestion()"
  (saved)="onSave($event)"
/>
