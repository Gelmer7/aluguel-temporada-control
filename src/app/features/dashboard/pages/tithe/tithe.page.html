<ng-template #headerActions>
  <p-button
    icon="pi pi-plus"
    (onClick)="onAddTithe()"
    [pTooltip]="'TITHE_MANAGEMENT.ADD_TITHE' | translate"
    tooltipPosition="left"
    [size]="'small'"
  />
  <p-button
    icon="pi pi-file-pdf"
    severity="secondary"
    (onClick)="onDownloadPDF()"
    [pTooltip]="'TITHE_MANAGEMENT.DOWNLOAD_PDF' | translate"
    tooltipPosition="left"
    [size]="'small'"
  />
</ng-template>

<p-toast />
<div class="flex flex-col gap-2 p-2 overflow-auto max-h-[calc(100vh)]">
  @if (loading()) {
    <div class="flex justify-center p-8">
      <i class="pi pi-spin pi-spinner text-4xl"></i>
    </div>
  } @else {
    <!-- Filtros e Resumo -->
    <div class="flex flex-col gap-1">
      <app-filter-container>
        <ng-template #filterSummary class="flex flex-wrap items-center gap-4">
          <span
            >{{ 'TERMS.YEAR' | translate }}:
            <span class="text-primary">{{ selectedYear() }}</span></span
          >
          <span
            >{{ 'TERMS.MONTH' | translate }}:
            <span class="text-primary">{{ 'MONTHS.' + selectedMonth() | translate }}</span></span
          >
          <span
            >Dízimo: <span class="text-primary">{{ tithePercentage() }}%</span></span
          >
          <span
            >Oferta: <span class="text-primary">{{ offerPercentage() }}%</span></span
          >
        </ng-template>

        <div class="flex flex-wrap items-center gap-4 w-full p-1">
          <p-floatLabel class="flex-1 min-w-[120px]" variant="in">
            <p-select
              [options]="years()"
              [(ngModel)]="selectedYear"
              [fluid]="true"
              id="year-select"
              variant="filled"
              showClear="true"
            />
            <label for="year-select">{{ 'TERMS.YEAR' | translate }}</label>
          </p-floatLabel>

          <p-floatLabel class="flex-1 min-w-[150px]" variant="in">
            <p-select
              inputId="month-select"
              [options]="months()"
              [(ngModel)]="selectedMonth"
              optionLabel="label"
              optionValue="value"
              [fluid]="true"
              variant="filled"
              showClear="true"
            />
            <label for="month-select">{{ 'TERMS.MONTH' | translate }}</label>
          </p-floatLabel>

          <p-floatLabel class="flex-1 min-w-[120px]" variant="in">
            <p-inputNumber
              [(ngModel)]="tithePercentage"
              [suffix]="' %'"
              [min]="0"
              [max]="100"
              [fluid]="true"
              inputId="tithe-percent"
              variant="filled"
              showClear="true"
            />
            <label for="tithe-percent">{{ 'TITHE_MANAGEMENT.TITHE_PERCENTAGE' | translate }}</label>
          </p-floatLabel>

          <p-floatLabel class="flex-1 min-w-[120px]" variant="in">
            <p-inputNumber
              [(ngModel)]="offerPercentage"
              [suffix]="' %'"
              [min]="0"
              [max]="100"
              [fluid]="true"
              id="offer-percent"
              variant="filled"
              showClear="true"
            />
            <label for="offer-percent">{{ 'TITHE_MANAGEMENT.OFFER_PERCENTAGE' | translate }}</label>
          </p-floatLabel>
        </div>
      </app-filter-container>

      <!-- Resumo -->
      <div class="shadow-sm border rounded-lg p-1 text-xs">
        <p-table [value]="[{}]" [responsiveLayout]="'scroll'" size="small">
          <ng-template pTemplate="header">
            <tr>
              <th class="!bg-transparent">{{ 'TITHE_MANAGEMENT.AIRBNB_PAYMENTS' | translate }}</th>
              <th class="!bg-transparent">{{ 'TITHE_MANAGEMENT.TOTAL_EXPENSES' | translate }}</th>
              <th class="!bg-transparent">
                {{ 'TITHE_MANAGEMENT.TITHE_VALUE' | translate: { percentage: tithePercentage() } }}
              </th>
              <th class="!bg-transparent">
                {{ 'TITHE_MANAGEMENT.OFFER_VALUE' | translate: { percentage: offerPercentage() } }}
              </th>
              <th class="!bg-transparent">{{ 'TITHE_MANAGEMENT.TOTAL_TO_PAY' | translate }}</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body">
            <tr>
              <td class="font-semibold">{{ totalAirbnb() | currency: 'BRL' }}</td>
              <td class="font-semibold text-red-500">{{ totalExpenses() | currency: 'BRL' }}</td>
              <td class="font-semibold text-primary">{{ titheValue() | currency: 'BRL' }}</td>
              <td class="font-semibold text-primary">{{ offerValue() | currency: 'BRL' }}</td>
              <td class="font-semibold bg-primary/10">{{ totalToPay() | currency: 'BRL' }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <!-- Tabela de Pagamentos -->
    <div class="flex-1 rounded-xl shadow-sm border flex flex-col p-1">
      <div
        class="flex items-center justify-between p-1 border-b border-surface-200 dark:border-surface-700 bg-surface-50/50 dark:bg-surface-800/50"
      >
        <span class="font-bold text-sm">{{ 'TITHE_MANAGEMENT.PAYMENTS_LIST' | translate }}</span>
      </div>
      <div class="flex-1 w-full overflow-auto flex flex-col">
        <p-table
          [value]="filteredPayments()"
          [rows]="10"
          [paginator]="true"
          [loading]="loading()"
          [scrollable]="true"
          scrollHeight="flex"
          class="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'EXPENSES_FORM.DATE' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.GUEST' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.CONFIRMATION_CODE' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.HOUSE_CODE' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.TYPE' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'TERMS.START_DATE' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.END_DATE' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.PAID' | translate }}</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-payment>
            <tr
              class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200"
            >
              <td class="truncate">{{ payment.data | date: 'dd/MM/yy' }}</td>
              <td class="truncate">{{ payment.hospede }}</td>
              <td class="truncate">{{ payment.codigo_confirmacao }}</td>
              <td class="truncate">{{ payment.house_code }}</td>
              <td class="truncate">{{ payment.tipo }}</td>
              <td class="truncate">{{ payment.data_inicio | date: 'dd/MM/yy' }}</td>
              <td class="truncate">{{ payment.data_termino | date: 'dd/MM/yy' }}</td>
              <td class="truncate font-medium">{{ payment.pago | currency: 'BRL' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="7" class="text-right font-bold bg-surface-50/50 dark:bg-surface-800/50">
                Total:
              </td>
              <td class="font-bold text-primary bg-surface-50/50 dark:bg-surface-800/50">
                {{ totalAirbnb() | currency: 'BRL' }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <!-- Tabela de Despesas -->
    <div class="flex-1 rounded-xl shadow-sm border flex flex-col p-1">
      <div
        class="flex items-center justify-between p-1 border-b border-surface-200 dark:border-surface-700 bg-surface-50/50 dark:bg-surface-800/50"
      >
        <span class="font-bold text-sm">{{ 'TITHE_MANAGEMENT.EXPENSES_LIST' | translate }}</span>
      </div>
      <div class="flex-1 min-h-0 w-full overflow-auto flex flex-col">
        <p-table
          [value]="filteredExpenses()"
          [rows]="10"
          [paginator]="true"
          [loading]="loading()"
          [scrollable]="true"
          scrollHeight="flex"
          class="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'EXPENSES_FORM.DATE' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'EXPENSES_FORM.DESCRIPTION' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'EXPENSES_FORM.TYPE' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'EXPENSES_FORM.PRICE' | translate }}
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-expense>
            <tr
              class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200"
            >
              <td class="truncate">{{ expense.purchaseDate | date: 'dd/MM/yyyy' }}</td>
              <td class="truncate">{{ expense.description }}</td>
              <td class="truncate">{{ expense.type }}</td>
              <td class="truncate font-medium">{{ expense.price | currency: 'BRL' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="3" class="text-right font-bold bg-surface-50/50 dark:bg-surface-800/50">
                Total:
              </td>
              <td class="font-bold text-red-500 bg-surface-50/50 dark:bg-surface-800/50">
                {{ totalExpenses() | currency: 'BRL' }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <!-- Tabela Histórico de Dízimos -->
    <div class="flex-1 rounded-xl shadow-sm border flex flex-col p-1">
      <div
        class="flex items-center justify-between p-1 border-b border-surface-200 dark:border-surface-700 bg-surface-50/50 dark:bg-surface-800/50"
      >
        <span class="font-bold text-sm">{{ 'TITHE_MANAGEMENT.HISTORY' | translate }}</span>
      </div>
      <div class="flex-1 min-h-0 w-full overflow-auto flex flex-col">
        <p-table
          [value]="titheHistory()"
          [rows]="10"
          [paginator]="true"
          [loading]="loading()"
          [scrollable]="true"
          scrollHeight="flex"
          class="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.MONTH' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'TITHE_MANAGEMENT.AIRBNB_PAYMENTS' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'TITHE_MANAGEMENT.TITHE_VALUE' | translate: { percentage: '' } }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'TITHE_MANAGEMENT.OFFER_VALUE' | translate: { percentage: '' } }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'TITHE_MANAGEMENT.TOTAL_TO_PAY' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800" style="width: 4rem"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-tithe>
            <tr
              class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200"
            >
              <td class="truncate">{{ tithe.monthYear | date: 'MM/yyyy' }}</td>
              <td class="truncate">{{ tithe.airbnbGross | currency: 'BRL' }}</td>
              <td class="truncate">{{ tithe.titheValue | currency: 'BRL' }}</td>
              <td class="truncate">{{ tithe.offerValue | currency: 'BRL' }}</td>
              <td class="truncate font-bold text-primary">
                {{ tithe.totalPaid | currency: 'BRL' }}
              </td>
              <td class="text-center">
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  size="small"
                  (click)="onDeleteTithe(tithe.id)"
                />
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center p-4">
                {{ 'TITHE_MANAGEMENT.NO_HISTORY' | translate }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  }
</div>

<!-- Modal Adicionar Dízimo -->
<app-dialog
  [(visible)]="showAddDialog"
  [header]="'TITHE_MANAGEMENT.ADD_TITHE' | translate"
  [icon]="'pi pi-heart'"
  (onSave)="onSaveTithe()"
  (onCancel)="showAddDialog.set(false)"
>
  <div class="flex flex-col gap-2 p-2">
    <p-iftalabel>
      <p-inputNumber
        [(ngModel)]="titheValueToPay"
        mode="currency"
        currency="BRL"
        locale="pt-BR"
        [fluid]="true"
        id="tithe-value-pay"
      />
      <label for="tithe-value-pay">{{
        'TITHE_MANAGEMENT.TITHE_VALUE' | translate: { percentage: tithePercentage() }
      }}</label>
    </p-iftalabel>

    <p-iftalabel>
      <p-inputNumber
        [(ngModel)]="offerValueToPay"
        mode="currency"
        currency="BRL"
        locale="pt-BR"
        [fluid]="true"
        id="offer-value-pay"
      />
      <label for="offer-value-pay">{{
        'TITHE_MANAGEMENT.OFFER_VALUE' | translate: { percentage: offerPercentage() }
      }}</label>
    </p-iftalabel>

    <p-iftalabel>
      <textarea
        pInputTextarea
        [(ngModel)]="titheObservation"
        rows="3"
        [fluid]="true"
        id="tithe-observation"
        class="w-full"
        style="resize: none"
      ></textarea>
      <label for="tithe-observation">{{ 'EXPENSES_FORM.OBSERVATION' | translate }}</label>
    </p-iftalabel>

    <div class="p-2 bg-surface-100 dark:bg-surface-800 rounded-lg">
      <div class="flex justify-between items-center">
        <span>{{ 'TITHE_MANAGEMENT.TOTAL_TO_PAY' | translate }}</span>
        <span class="text-xl">{{ titheValueToPay() + offerValueToPay() | currency: 'BRL' }}</span>
      </div>
    </div>
  </div>
</app-dialog>
