<div class="p-1.5 sm:p-2 flex flex-col gap-2 min-h-0 bg-surface-50 dark:bg-surface-950">
  <!-- Header with Actions -->
  <app-page-header
    [title]="'TERMS.EXPENSES'"
    [icon]="'pi-wallet'"
    [showAction]="true"
    [actionTooltip]="'Novo Gasto'"
    (onAction)="onAddExpense()"
  />

  <!-- Filtros Reutilizáveis -->
  <app-filter-container>
    <!-- Resumo dos filtros (aparece quando colapsado) -->
    <ng-template #filterSummary>
      <span>Ano: <span class="text-primary">{{ selectedYear() || 'Todos' }}</span></span>
      <span>Mês: <span class="text-primary">{{ getSelectedMonthLabel() }}</span></span>
      <span>Tipo: <span class="text-primary">{{ getSelectedTypeLabel() }}</span></span>
    </ng-template>

    <!-- Conteúdo dos filtros -->
    <div class="flex flex-1 min-w-[120px] items-center gap-1.5">
      <span class="text-surface-600 dark:text-surface-400 font-medium">Tipo</span>
      <p-select
        [options]="typeOptions"
        [ngModel]="selectedType()"
        (ngModelChange)="selectedType.set($event); onFilterChange()"
        placeholder="Todos"
        [showClear]="true"
        class="flex-1 !h-8"
        appendTo="body"
      ></p-select>
    </div>

    <div class="flex flex-1 min-w-[100px] items-center gap-1.5">
      <span class="text-surface-600 dark:text-surface-400 font-medium">Ano</span>
      <p-select
        [options]="yearOptions()"
        [ngModel]="selectedYear()"
        (ngModelChange)="selectedYear.set($event); onFilterChange()"
        placeholder="Todos"
        [showClear]="true"
        class="flex-1 !h-8"
        appendTo="body"
      ></p-select>
    </div>

    <div class="flex flex-1 min-w-[100px] items-center gap-1.5">
      <span class="text-surface-600 dark:text-surface-400 font-medium">Mês</span>
      <p-select
        [options]="monthOptions"
        [ngModel]="selectedMonth()"
        (ngModelChange)="selectedMonth.set($event); onFilterChange()"
        [disabled]="!selectedYear()"
        placeholder="Todos"
        [showClear]="true"
        class="flex-1 !h-8"
        appendTo="body"
      ></p-select>
    </div>

    <div class="flex items-center">
      <p-button
        label="Limpar Filtros"
        icon="pi pi-filter-slash"
        [text]="true"
        severity="secondary"
        size="small"
        class="h-8"
        (click)="
          selectedType.set(null); selectedYear.set(null); selectedMonth.set(null); onFilterChange()
        "
      />
    </div>
  </app-filter-container>

  <!-- Data Table Section -->
  <div
    class="flex-1 min-h-0 bg-surface-0 dark:bg-surface-900 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex flex-col overflow-hidden"
  >
    <!-- Table Header Toolbar -->
    <div
      class="flex-none flex flex-col sm:flex-row sm:items-center justify-between p-2 sm:p-2.5 border-b border-surface-200 dark:border-surface-700 gap-2"
    >
      <p-iconfield iconPosition="left" class="w-full sm:max-w-xs">
        <p-inputicon>
          <i class="pi pi-search text-xs sm:text-base"></i>
        </p-inputicon>
        <input
          pInputText
          type="text"
          [ngModel]="globalFilter()"
          (ngModelChange)="onFilterGlobal($event)"
          placeholder="Buscar..."
          class="w-full !py-1 sm:!py-2 text-xs sm:text-sm"
        />
      </p-iconfield>
    </div>

    <!-- Scrollable Table Content -->
    <div class="flex-1 min-h-0 w-full overflow-auto flex flex-col">
      <p-table
        #dt
        [value]="pagedExpenses()"
        [loading]="loading()"
        [scrollable]="true"
        scrollHeight="flex"
        styleClass="p-datatable-sm h-full flex flex-col"
        [tableStyle]="{ 'min-width': '35rem' }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th
              pSortableColumn="purchase_date"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3 text-[10px] sm:text-sm"
            >
              Data <p-sortIcon field="purchase_date" />
            </th>
            <th
              pSortableColumn="description"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3 text-[10px] sm:text-sm"
            >
              Descrição <p-sortIcon field="description" />
            </th>
            <th
              pSortableColumn="type"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3 text-[10px] sm:text-sm hidden sm:table-cell"
            >
              Tipo <p-sortIcon field="type" />
            </th>
            <th
              pSortableColumn="price"
              class="bg-surface-50 dark:bg-surface-800 text-right !py-1.5 sm:!py-3 text-[10px] sm:text-sm"
            >
              Valor <p-sortIcon field="price" />
            </th>
            <th
              class="bg-surface-50 dark:bg-surface-800 text-center w-24 sm:w-32 !py-1.5 sm:!py-3 text-[10px] sm:text-sm"
            >
              Ações
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-expense>
          <tr
            class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200"
          >
            <td class="!p-1.5 sm:!p-2 text-[10px] sm:text-sm">
              {{ expense.purchase_date | date: 'dd/MM/yy' }}
            </td>
            <td class="!p-1.5 sm:!p-2 text-[10px] sm:text-sm">
              <div class="flex flex-col">
                <span class="font-medium text-surface-900 dark:text-surface-0">{{
                  expense.description
                }}</span>
                <span class="sm:hidden text-[9px] text-surface-500 uppercase">{{
                  expense.type
                }}</span>
                @if (expense.observation) {
                  <span
                    class="hidden sm:block text-[10px] text-surface-500 truncate max-w-[100px] md:max-w-xs"
                    [pTooltip]="expense.observation"
                  >
                    {{ expense.observation }}
                  </span>
                }
              </div>
            </td>
            <td class="!p-1.5 sm:!p-2 hidden sm:table-cell">
              <p-tag
                [value]="expense.type"
                [severity]="getSeverity(expense.type)"
                styleClass="text-[10px]"
              />
            </td>
            <td
              class="!p-1.5 sm:!p-2 text-right font-bold text-surface-900 dark:text-surface-0 text-[10px] sm:text-sm"
            >
              {{ expense.price | currency: 'BRL' }}
            </td>
            <td class="!p-1.5 sm:!p-2">
              <div class="flex justify-center gap-1 sm:gap-2">
                <p-button
                  icon="pi pi-pencil"
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  (click)="onEditExpense(expense)"
                  pTooltip="Editar"
                  styleClass="!w-7 !h-7 sm:!w-8 sm:!h-8"
                />
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  (click)="onDeleteExpense($event, expense)"
                  pTooltip="Excluir"
                  styleClass="!w-7 !h-7 sm:!w-8 sm:!h-8"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center p-8">
              <div class="flex flex-col items-center gap-3">
                <i class="pi pi-inbox text-4xl text-surface-300"></i>
                <span class="text-surface-500">Nenhum gasto encontrado.</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Paginator Footer -->
    <app-table-paginator
      [first]="first()"
      [rows]="rows()"
      [totalRecords]="filteredExpenses().length"
      [rowsPerPageOptions]="[10, 20, 50, 100]"
      (onPageChange)="onPageChange($event)"
    />
  </div>

  <!-- Form Dialog -->
  <app-expense-form
    [visible]="showExpenseForm()"
    (visibleChange)="showExpenseForm.set($event)"
    [editData]="currentExpense()"
    (save)="onSaveExpense($event)"
  />

  <!-- Confirmations and Toasts -->
  <p-confirmdialog />
  <p-toast position="bottom-right" />
</div>
