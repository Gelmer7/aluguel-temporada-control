<ng-template #headerActions>
  <div class="flex items-center gap-2">
    <p-button
      icon="pi pi-file-pdf"
      severity="secondary"
      (onClick)="onDownloadPDF()"
      [pTooltip]="'TITHE_MANAGEMENT.DOWNLOAD_PDF' | translate"
      tooltipPosition="left"
      [size]="'small'"
    />
    <p-button
      icon="pi pi-plus"
      (onClick)="onAddExpense()"
      pTooltip="Novo Gasto"
      tooltipPosition="left"
      [size]="'small'"
    />
  </div>
</ng-template>

<div class="p-1.5 sm:p-2 flex flex-col gap-2 min-h-0 bg-surface-50 dark:bg-surface-950">
  <!-- Filtros Reutilizáveis -->
  <app-filter-container>
    <!-- Resumo dos filtros (aparece quando colapsado) -->
    <ng-template #filterSummary>
      @if (filterDateRange()) {
        <span
          >Período:
          <span class="text-primary">{{ getFormattedDateRange() }}</span></span
        >
      }
      <span
        >{{ 'TERMS.YEAR' | translate }}:
        <span class="text-primary">{{ getSelectedYearLabel() | translate }}</span></span
      >
      <span
        >{{ 'TERMS.MONTH' | translate }}:
        <span class="text-primary">{{ getSelectedMonthLabel() | translate }}</span></span
      >
      <span
        >{{ 'TERMS.TYPE' | translate }}:
        <span class="text-primary">{{ getSelectedTypeLabel() | translate }}</span></span
      >
    </ng-template>

    <!-- Conteúdo dos filtros -->


    <!-- Ano -->
    <p-floatlabel class="flex-1 min-w-[100px]" variant="in">
      <p-select
        inputId="year_select"
        [options]="yearOptions()"
        [ngModel]="selectedYear()"
        (ngModelChange)="selectedYear.set($event || 'ALL'); onFilterChange()"
        [showClear]="true"
        class="w-full"
        appendTo="body"
        optionLabel="label"
        optionValue="value"
      >
        <ng-template pTemplate="selectedItem" let-selectedOption>
          {{ selectedOption.label | translate }}
        </ng-template>
        <ng-template pTemplate="item" let-option>
          {{ option.label | translate }}
        </ng-template>
      </p-select>
      <label for="year_select">{{ 'TERMS.YEAR' | translate }}</label>
    </p-floatlabel>
    <!-- Mês -->
    <p-floatlabel class="flex-1 min-w-[100px]" variant="in">
      <p-multiselect
        inputId="month_select"
        [options]="monthOptions"
        [ngModel]="selectedMonth()"
        (ngModelChange)="selectedMonth.set($event || []); onFilterChange()"
        class="w-full"
        appendTo="body"
        optionLabel="label"
        optionValue="value"
        [maxSelectedLabels]="2"
        [selectedItemsLabel]="'{0} ' + ('TERMS.SELECTED' | translate)"
      >
        <ng-template pTemplate="selectedItem" let-selectedOption>
          {{ selectedOption.label | translate }}
        </ng-template>
        <ng-template pTemplate="item" let-option>
          {{ option.label | translate }}
        </ng-template>
      </p-multiselect>
      <label for="month_select">{{ 'TERMS.MONTH' | translate }}</label>
    </p-floatlabel>
    <!-- Tipo -->
    <p-floatlabel class="flex-1 min-w-[150px]" variant="in">
      <p-multiselect
        inputId="type_select"
        [options]="expenseTypes"
        [ngModel]="selectedTypes()"
        (ngModelChange)="selectedTypes.set($event || []); onFilterChange()"
        class="w-full"
        appendTo="body"
        optionLabel="label"
        optionValue="value"
        [maxSelectedLabels]="2"
        [selectedItemsLabel]="'{0} ' + ('TERMS.SELECTED' | translate)"
      >
        <ng-template pTemplate="selectedItem" let-selectedOption>
          {{ selectedOption.label | translate }}
        </ng-template>
        <ng-template pTemplate="item" let-option>
          {{ option.label | translate }}
        </ng-template>
      </p-multiselect>
      <label for="type_select">{{ 'TERMS.TYPE' | translate }}</label>
    </p-floatlabel>
        <!-- Filtro de Período via Popover -->
    <div class="flex items-center self-center h-full">
      <p-button
        icon="pi pi-calendar"
        [rounded]="true"
        [text]="true"
        (click)="op_date_filter.toggle($event)"
        [pTooltip]="'Filtrar por período'"
        tooltipPosition="top"
        [severity]="filterDateRange() ? 'primary' : 'secondary'"
        [styleClass]="filterDateRange() ? 'shadow-[0_0_10px_rgba(var(--p-primary-500-rgb),0.4)] bg-primary/10' : ''"
      >
        @if (filterDateRange()) {
          <span
            class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-primary text-[10px] text-white animate-pulse"
          >
            !
          </span>
        }
      </p-button>

      <p-popover #op_date_filter>
        <div class="p-3 flex flex-col gap-3 min-w-[280px]">
          <div class="flex items-center justify-between border-b border-surface-200 dark:border-surface-700 pb-2">
            <span class="text-sm font-semibold text-surface-700 dark:text-surface-100">Selecionar Período</span>
            @if (filterDateRange()) {
              <p-button
                icon="pi pi-trash"
                [text]="true"
                severity="danger"
                size="small"
                (click)="onDateRangeChange(null); op_date_filter.hide()"
                pTooltip="Limpar Filtro"
              />
            }
          </div>
          <div class="flex flex-col gap-1">
            <label for="popover_range_date" class="text-xs text-surface-500 mb-1">Intervalo de Datas</label>
            <p-datepicker
              inputId="popover_range_date"
              [ngModel]="filterDateRange()"
              (ngModelChange)="onDateRangeChange($event)"
              selectionMode="range"
              [showIcon]="true"
              [showClear]="false"
              [readonlyInput]="false"
              class="w-full"
              appendTo="body"
              dateFormat="dd/mm/yy"
              placeholder="00/00/0000 - 00/00/0000"
              styleClass="w-full"
            ></p-datepicker>
          </div>
          <div class="text-[10px] text-surface-400 italic">
            Dica: Você pode digitar as datas ou usar o calendário.
          </div>
        </div>
      </p-popover>
    </div>
    <!-- Limpar Filtros -->
    <div class="flex items-center">
      <p-button
        icon="pi pi-filter-slash"
        [text]="true"
        severity="secondary"
        size="small"
        class="p-button-sm"
        (click)="clearFilters()"
      />
    </div>
  </app-filter-container>

  <!-- Data Table Section -->
  <div
    class="flex-1 min-h-0 bg-surface-0 dark:bg-surface-900 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex flex-col overflow-hidden"
  >
    <!-- Table Header Toolbar -->
    <div
      class="flex items-center justify-start p-1 border-b border-surface-200 dark:border-surface-700"
    >
      <p-iconfield iconPosition="left" class="w-full sm:max-w-xs">
        <p-inputicon>
          <i class="pi pi-search text-xs sm:text-base"></i>
        </p-inputicon>
        <input
          pInputText
          type="text"
          [ngModel]="globalFilter()"
          (ngModelChange)="onFilterGlobal($event)"
          [placeholder]="'TERMS.SEARCH' | translate"
          class="w-full !py-1 sm:!py-2 text-xs sm:text-sm"
        />
      </p-iconfield>
      <p-button
        icon="pi pi-chart-line"
        variant="text"
        [pTooltip]="'TERMS.CHARTS' | translate"
        (click)="showCharts.set(true)"
        class="ml-auto"
      />
    </div>

    <!-- Scrollable Table Content -->
    <div class="flex-1 min-h-0 w-full overflow-auto flex flex-col">
      <p-table
        #dt
        [value]="pagedExpenses()"
        [loading]="loading()"
        [scrollable]="true"
        scrollHeight="flex"
        class="p-datatable-sm h-full flex flex-col text-xs sm:text-base"
      >
        <ng-template pTemplate="header">
          <tr class="text-xs sm:text-base">
            <th
              pSortableColumn="purchaseDate"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3"
            >
              Data
            </th>
            <th
              pSortableColumn="description"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3"
            >
              Descrição
            </th>
            <th
              pSortableColumn="type"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3 hidden sm:table-cell"
            >
              Tipo
            </th>
            <th
              pSortableColumn="price"
              class="bg-surface-50 dark:bg-surface-800 text-right !py-1.5 sm:!py-3"
            >
              Valor
            </th>
            <th class="bg-surface-50 dark:bg-surface-800 text-center w-24 sm:w-32 !py-1.5 sm:!py-3">
              Ações
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-expense>
          <tr
            class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200 text-xs sm:text-base"
          >
            <td class="!p-1.5 sm:!p-2">
              {{ expense.purchaseDate | date: 'dd/MM/yyyy' }}
            </td>
            <td class="!p-1.5 sm:!p-2">
              <div class="flex flex-col">
                <span class="font-medium text-surface-900 dark:text-surface-0">{{
                  expense.description
                }}</span>
                <span class="sm:hidden text-[9px] text-surface-500 uppercase">{{
                  expense.type
                }}</span>
                @if (expense.observation) {
                  <span
                    class="hidden sm:block text-[10px] text-surface-500 truncate max-w-[100px] md:max-w-xs"
                    [pTooltip]="expense.observation"
                  >
                    {{ expense.observation }}
                  </span>
                }
              </div>
            </td>
            <td class="!p-1.5 sm:!p-2 hidden sm:table-cell">
              <p-tag
                [value]="expense.type"
                [severity]="getSeverity(expense.type)"
                styleClass="text-[10px]"
              />
            </td>
            <td class="!p-1.5 sm:!p-2 text-right font-bold text-surface-900 dark:text-surface-0">
              {{ expense.price | currency: 'BRL' }}
            </td>
            <td class="!p-1.5 sm:!p-2">
              <div class="flex justify-center gap-1 sm:gap-2">
                <p-button
                  icon="pi pi-pencil"
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  (click)="onEditExpense(expense)"
                  pTooltip="Editar"
                  styleClass="!w-7 !h-7 sm:!w-8 sm:!h-8"
                />
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  (click)="onDeleteExpense($event, expense)"
                  pTooltip="Excluir"
                  styleClass="!w-7 !h-7 sm:!w-8 sm:!h-8"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="footer">
          <tr>
            <td colspan="3" class="text-right font-bold bg-surface-50 dark:bg-surface-800 !py-2 hidden sm:table-cell">
              TOTAL:
            </td>
            <td colspan="2" class="text-right font-bold bg-surface-50 dark:bg-surface-800 !py-2 sm:hidden">
              TOTAL:
            </td>
            <td class="text-right font-bold text-primary bg-surface-50 dark:bg-surface-800 !py-2">
              {{ totalExpenses() | currency: 'BRL' }}
            </td>
            <td class="bg-surface-50 dark:bg-surface-800 !py-2 hidden sm:table-cell"></td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center p-8">
              <div class="flex flex-col items-center gap-3">
                <i class="pi pi-inbox text-4xl text-surface-300"></i>
                <span class="text-surface-500">Nenhum gasto encontrado.</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Paginator Footer -->
    <app-table-paginator
      [first]="first()"
      [rows]="rows()"
      [totalRecords]="filteredExpenses().length"
      [rowsPerPageOptions]="[10, 20, 50, 100]"
      (onPageChange)="onPageChange($event)"
    />
  </div>

  <!-- Form Dialog -->
  <app-expense-form
    [visible]="showExpenseForm()"
    (visibleChange)="showExpenseForm.set($event)"
    [editData]="currentExpense()"
    (save)="onSaveExpense($event)"
  />

  <!-- Charts Dialog -->
  <app-expense-charts
    [visible]="showCharts()"
    (visibleChange)="showCharts.set($event)"
    [expenses]="expenses()"
    [selectedYear]="selectedYear()"
    [selectedTypes]="selectedTypes()"
  />

  <!-- Confirmations and Toasts -->
  <p-confirmdialog />
  <p-toast position="bottom-right" />
</div>
