<div class="p-1.5 sm:p-2 flex flex-col gap-2 min-h-0 bg-surface-50 dark:bg-surface-950">
  <!-- Header with Actions -->
  <app-page-header
    [title]="'TERMS.EXPENSES'"
    [icon]="'pi-wallet'"
    [showAction]="true"
    [actionTooltip]="'Novo Gasto'"
    (onAction)="onAddExpense()"
  />

  <!-- Filtros Reutilizáveis -->
  <app-filter-container>
    <!-- Resumo dos filtros (aparece quando colapsado) -->
    <ng-template #filterSummary>
      <span
        >{{ 'TERMS.YEAR' | translate }}:
        <span class="text-primary">{{ getSelectedYearLabel() | translate }}</span></span
      >
      <span
        >{{ 'TERMS.MONTH' | translate }}:
        <span class="text-primary">{{ getSelectedMonthLabel() | translate }}</span></span
      >
      <span
        >{{ 'TERMS.TYPE' | translate }}:
        <span class="text-primary">{{ getSelectedTypeLabel() | translate }}</span></span
      >
    </ng-template>

    <!-- Conteúdo dos filtros -->
    <p-floatlabel class="flex-1 min-w-[120px]" variant="in">
      <p-select
        inputId="type_select"
        [options]="typeOptions"
        [ngModel]="selectedType()"
        (ngModelChange)="selectedType.set($event || 'ALL'); onFilterChange()"
        [showClear]="true"
        class="w-full"
        appendTo="body"
        optionLabel="label"
        optionValue="value"
      >
        <ng-template pTemplate="selectedItem" let-selectedOption>
          {{ selectedOption.label | translate }}
        </ng-template>
        <ng-template pTemplate="item" let-option>
          {{ option.label | translate }}
        </ng-template>
      </p-select>
      <label for="type_select">{{ 'TERMS.TYPE' | translate }}</label>
    </p-floatlabel>

    <p-floatlabel class="flex-1 min-w-[100px]" variant="in">
      <p-select
        inputId="year_select"
        [options]="yearOptions()"
        [ngModel]="selectedYear()"
        (ngModelChange)="selectedYear.set($event || 'ALL'); onFilterChange()"
        [showClear]="true"
        class="w-full"
        appendTo="body"
        optionLabel="label"
        optionValue="value"
      >
        <ng-template pTemplate="selectedItem" let-selectedOption>
          {{ selectedOption.label | translate }}
        </ng-template>
        <ng-template pTemplate="item" let-option>
          {{ option.label | translate }}
        </ng-template>
      </p-select>
      <label for="year_select">{{ 'TERMS.YEAR' | translate }}</label>
    </p-floatlabel>

    <p-floatlabel class="flex-1 min-w-[100px]" variant="in">
      <p-select
        inputId="month_select"
        [options]="monthOptions"
        [ngModel]="selectedMonth()"
        (ngModelChange)="selectedMonth.set($event || 'ALL'); onFilterChange()"
        [disabled]="selectedYear() === 'ALL'"
        [showClear]="true"
        class="w-full"
        appendTo="body"
        optionLabel="label"
        optionValue="value"
      >
        <ng-template pTemplate="selectedItem" let-selectedOption>
          {{ selectedOption.label | translate }}
        </ng-template>
        <ng-template pTemplate="item" let-option>
          {{ option.label | translate }}
        </ng-template>
      </p-select>
      <label for="month_select">{{ 'TERMS.MONTH' | translate }}</label>
    </p-floatlabel>

    <div class="flex items-center">
      <p-button
        [label]="'ACTIONS.CLEAR_FILTERS' | translate"
        icon="pi pi-filter-slash"
        [text]="true"
        severity="secondary"
        size="small"
        class="h-8"
        (click)="
          selectedType.set('ALL');
          selectedYear.set('ALL');
          selectedMonth.set('ALL');
          onFilterChange()
        "
      />
    </div>
  </app-filter-container>

  <!-- Data Table Section -->
  <div
    class="flex-1 min-h-0 bg-surface-0 dark:bg-surface-900 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex flex-col overflow-hidden"
  >
    <!-- Table Header Toolbar -->
    <div
      class="flex items-center justify-start p-1 border-b border-surface-200 dark:border-surface-700"
    >
      <p-iconfield iconPosition="left" class="w-full sm:max-w-xs">
        <p-inputicon>
          <i class="pi pi-search text-xs sm:text-base"></i>
        </p-inputicon>
        <input
          pInputText
          type="text"
          [ngModel]="globalFilter()"
          (ngModelChange)="onFilterGlobal($event)"
          [placeholder]="'TERMS.SEARCH' | translate"
          class="w-full !py-1 sm:!py-2 text-xs sm:text-sm"
        />
      </p-iconfield>
      <p-button icon="pi pi-chart-pie" variant="text" [pTooltip]="'TERMS.CHARTS' | translate" />
    </div>

    <!-- Scrollable Table Content -->
    <div class="flex-1 min-h-0 w-full overflow-auto flex flex-col">
      <p-table
        #dt
        [value]="pagedExpenses()"
        [loading]="loading()"
        [scrollable]="true"
        scrollHeight="flex"
        class="p-datatable-sm h-full flex flex-col text-xs sm:text-base"
      >
        <ng-template pTemplate="header">
          <tr class="text-xs sm:text-base">
            <th
              pSortableColumn="purchase_date"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3"
            >
              Data
            </th>
            <th
              pSortableColumn="description"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3"
            >
              Descrição
            </th>
            <th
              pSortableColumn="type"
              class="bg-surface-50 dark:bg-surface-800 !py-1.5 sm:!py-3 hidden sm:table-cell"
            >
              Tipo
            </th>
            <th
              pSortableColumn="price"
              class="bg-surface-50 dark:bg-surface-800 text-right !py-1.5 sm:!py-3"
            >
              Valor
            </th>
            <th class="bg-surface-50 dark:bg-surface-800 text-center w-24 sm:w-32 !py-1.5 sm:!py-3">
              Ações
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-expense>
          <tr
            class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200 text-xs sm:text-base"
          >
            <td class="!p-1.5 sm:!p-2">
              {{ expense.purchase_date | date: 'dd/MM/yyyy' }}
            </td>
            <td class="!p-1.5 sm:!p-2">
              <div class="flex flex-col">
                <span class="font-medium text-surface-900 dark:text-surface-0">{{
                  expense.description
                }}</span>
                <span class="sm:hidden text-[9px] text-surface-500 uppercase">{{
                  expense.type
                }}</span>
                @if (expense.observation) {
                  <span
                    class="hidden sm:block text-[10px] text-surface-500 truncate max-w-[100px] md:max-w-xs"
                    [pTooltip]="expense.observation"
                  >
                    {{ expense.observation }}
                  </span>
                }
              </div>
            </td>
            <td class="!p-1.5 sm:!p-2 hidden sm:table-cell">
              <p-tag
                [value]="expense.type"
                [severity]="getSeverity(expense.type)"
                styleClass="text-[10px]"
              />
            </td>
            <td class="!p-1.5 sm:!p-2 text-right font-bold text-surface-900 dark:text-surface-0">
              {{ expense.price | currency: 'BRL' }}
            </td>
            <td class="!p-1.5 sm:!p-2">
              <div class="flex justify-center gap-1 sm:gap-2">
                <p-button
                  icon="pi pi-pencil"
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  (click)="onEditExpense(expense)"
                  pTooltip="Editar"
                  styleClass="!w-7 !h-7 sm:!w-8 sm:!h-8"
                />
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  (click)="onDeleteExpense($event, expense)"
                  pTooltip="Excluir"
                  styleClass="!w-7 !h-7 sm:!w-8 sm:!h-8"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center p-8">
              <div class="flex flex-col items-center gap-3">
                <i class="pi pi-inbox text-4xl text-surface-300"></i>
                <span class="text-surface-500">Nenhum gasto encontrado.</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Paginator Footer -->
    <app-table-paginator
      [first]="first()"
      [rows]="rows()"
      [totalRecords]="filteredExpenses().length"
      [rowsPerPageOptions]="[10, 20, 50, 100]"
      (onPageChange)="onPageChange($event)"
    />
  </div>

  <!-- Form Dialog -->
  <app-expense-form
    [visible]="showExpenseForm()"
    (visibleChange)="showExpenseForm.set($event)"
    [editData]="currentExpense()"
    (save)="onSaveExpense($event)"
  />

  <!-- Confirmations and Toasts -->
  <p-confirmdialog />
  <p-toast position="bottom-right" />
</div>
