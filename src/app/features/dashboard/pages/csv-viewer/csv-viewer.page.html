<!-- Container principal da página -->
<p-toast />
<div class="h-full flex flex-col p-2 bg-surface-50 dark:bg-surface-950 gap-2 overflow-hidden">
  <!-- Header com Ações -->
  <div class="flex items-center justify-between gap-1">
    <app-page-header [title]="'ACTIONS.VIEW_CSV'" [icon]="'pi-table'" class="flex-1" />

    <div class="flex items-center gap-1">
      <p-button
        icon="pi pi-upload"
        label="Subir"
        severity="secondary"
        [outlined]="true"
        size="small"
        (click)="fileInput.click()"
        pTooltip="Carregar novo relatório do Airbnb"
        tooltipPosition="left"
      />
      <input
        #fileInput
        type="file"
        (change)="onFileSelected($event)"
        accept=".csv"
        class="hidden"
      />

      <p-button
        icon="pi pi-sync"
        [severity]="syncing() ? 'warn' : 'primary'"
        size="small"
        (click)="syncDatabase()"
        [loading]="syncing()"
        [disabled]="rows().length === 0"
        pTooltip="Salvar os dados atuais no banco de dados (evita duplicatas)"
        tooltipPosition="bottom"
      />
    </div>
  </div>

  <!-- Filtros Reutilizáveis -->
  <app-filter-container>
    <!-- Resumo dos filtros (aparece quando colapsado) -->
    <ng-template #filterSummary>
      <span
        >Ano: <span class="text-primary">{{ selectedYear() || 'Todos' }}</span></span
      >
      <span
        >Mês: <span class="text-primary">{{ getSelectedMonthLabel() }}</span></span
      >
      <span
        >Tipo: <span class="text-primary">{{ selectedType() || 'Todos' }}</span></span
      >
    </ng-template>

    <!-- Conteúdo dos filtros -->
    <p-floatlabel class="flex-1 min-w-[120px]" variant="in">
      <p-select
        inputId="year_select"
        [options]="years()"
        [ngModel]="selectedYear()"
        (ngModelChange)="onYearChange($event)"
        [showClear]="true"
        class="w-full"
        appendTo="body"
      ></p-select>
      <label for="year_select">Ano</label>
    </p-floatlabel>

    <p-floatlabel class="flex-1 min-w-[120px]" variant="in">
      <p-select
        inputId="month_select"
        [options]="months"
        [ngModel]="selectedMonth()"
        (ngModelChange)="onMonthChange($event)"
        optionLabel="label"
        optionValue="value"
        [showClear]="true"
        class="w-full"
        appendTo="body"
      ></p-select>
      <label for="month_select">Mês</label>
    </p-floatlabel>

    <p-floatlabel class="flex-1 min-w-[120px]" variant="in">
      <p-select
        inputId="type_select"
        [options]="types()"
        [ngModel]="selectedType()"
        (ngModelChange)="onTypeChange($event)"
        [showClear]="true"
        class="w-full"
        appendTo="body"
      ></p-select>
      <label for="type_select">Tipo</label>
    </p-floatlabel>
    <div
      class="flex items-center gap-1.5 sm:border-l sm:border-surface-200 sm:dark:border-surface-700 sm:pl-3"
    >
      <span class="text-surface-600 dark:text-surface-400 font-medium whitespace-nowrap"
        >Payout</span
      >
      <p-checkbox
        [ngModel]="hidePayout()"
        (ngModelChange)="onHidePayoutChange($event)"
        binary="true"
      ></p-checkbox>
    </div>
    <p-floatlabel class="w-full" variant="in">
      <p-multiselect
        inputId="cols_select"
        display="chip"
        [options]="cols()"
        [ngModel]="selectedColumns()"
        (ngModelChange)="onColumnsChange($event)"
        optionLabel="headerFull"
        selectedItemsLabel="{0} colunas"
        appendTo="body"
        class="w-full"
        [maxSelectedLabels]="3"
      ></p-multiselect>
      <label for="cols_select">Colunas</label>
    </p-floatlabel>
  </app-filter-container>

  <!-- Summary Cards Agrupados -->
  <div class="flex-none grid grid-cols-1 sm:grid-cols-2 gap-2">
    <!-- Card 1: Financeiro (Luiza & Gelmer) -->
    <div
      class="bg-surface-0 dark:bg-surface-900 p-2 rounded-lg shadow-sm border border-surface-200 dark:border-surface-700 flex items-center justify-around gap-4"
    >
      <!-- Luiza -->
      <div class="flex items-center gap-2">
        <div
          class="w-8 h-8 rounded bg-pink-50 dark:bg-pink-900/20 flex items-center justify-center"
        >
          <i class="pi pi-user text-pink-500 text-xs"></i>
        </div>
        <div>
          <p class="text-[9px] text-surface-500 uppercase font-bold m-0 leading-tight">Luiza</p>
          <p class="text-sm font-bold text-surface-900 dark:text-surface-0 m-0">
            {{ summary().luizaValor | currency: 'BRL' }}
          </p>
        </div>
      </div>
      <!-- Separador vertical -->
      <div class="h-8 border-l border-surface-200 dark:border-surface-700"></div>
      <!-- Gelmer -->
      <div class="flex items-center gap-2">
        <div
          class="w-8 h-8 rounded bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center"
        >
          <i class="pi pi-user text-blue-500 text-xs"></i>
        </div>
        <div>
          <p class="text-[9px] text-surface-500 uppercase font-bold m-0 leading-tight">Gelmer</p>
          <p class="text-sm font-bold text-surface-900 dark:text-surface-0 m-0">
            {{ summary().gelmerValor | currency: 'BRL' }}
          </p>
        </div>
      </div>
    </div>

    <!-- Limpeza/ Noites -->
    <div class="flex items-center justify-end gap-2 px-2">
      <div>
        <p class="text-sm text-end">
          Limpeza: {{ summary().totalLimpeza | currency: 'BRL' }} | Noites:
          {{ summary().totalNoites }}
        </p>
      </div>
    </div>
  </div>

  <!-- Área da tabela com scroll -->
  <div
    class="flex-1 min-h-0 bg-surface-0 dark:bg-surface-900 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex flex-col overflow-hidden"
  >
    <!-- Barra de ferramentas superior (caption) -->
    <div
      class="flex items-center justify-start p-1 border-b border-surface-200 dark:border-surface-700"
    >
      <p-iconfield iconPosition="left" class="flex-1 sm:flex-none sm:w-80">
        <p-inputicon>
          <i class="pi pi-search"></i>
        </p-inputicon>
        <input
          pInputText
          type="text"
          [ngModel]="filterQuery()"
          (ngModelChange)="onFilter($event)"
          placeholder="Pesquisar..."
          class="w-full p-inputtext-sm"
        />
      </p-iconfield>
      <p-button icon="pi pi-info-circle" [text]="true" (click)="op.toggle($event)" />
      <p-popover #op>
        <div class="flex flex-col gap-2 p-1">
          <div
            class="flex items-center gap-2 border-b border-surface-200 dark:border-surface-700 pb-2 mb-1"
          >
            <i class="pi pi-file text-primary text-sm"></i>
            <span class="font-bold text-xs">Informações do Arquivo:</span>
          </div>

          <div class="text-sm text-surface-600 dark:text-surface-400 leading-relaxed">
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-surface-900 dark:text-surface-0"
                >Última Data: {{ dateRange().last || '---' }}</span
              >
              <span class="font-semibold text-surface-900 dark:text-surface-0"
                >Primeira Data: {{ dateRange().first || '---' }}</span
              >
            </div>
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-surface-900 dark:text-surface-0">Fonte:</span>
              <code
                class="bg-surface-100 dark:bg-surface-800 p-1 rounded border border-surface-200 dark:border-surface-700 break-all"
              >
                {{ rows().length > 0 ? 'Banco de Dados (airbnb_logs)' : 'Arquivo Local' }}
              </code>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <span
                class="inline-block w-2 h-2 rounded-full"
                [ngClass]="rows().length > 0 ? 'bg-green-500' : 'bg-yellow-500'"
              ></span>
              <span
                >Status: {{ rows().length > 0 ? 'Sincronizado' : 'Aguardando Sincronização' }}</span
              >
            </div>
          </div>
        </div>
      </p-popover>
    </div>

    <div class="flex-1 min-h-0 w-full overflow-auto flex flex-col">
      <p-table
        #dt
        [columns]="selectedColumns()"
        [value]="pagedRows()"
        [scrollable]="true"
        scrollHeight="flex"
        sortMode="single"
        sortField="Data"
        rowGroupMode="subheader"
        [groupRowsBy]="'Data'"
        rowGroupExpandMode="multiple"
        [globalFilterFields]="headers()"
        [tableStyle]="{ 'min-width': '80rem' }"
        dataKey="__id"
        [rowTrackBy]="rowTrackBy"
        [loading]="loading()"
        styleClass="p-datatable-sm h-full flex flex-col"
      >
        <!-- Sub-cabeçalho de grupo (Data) -->
        <ng-template pTemplate="rowgroupheader" let-row>
          <tr class="bg-surface-50 dark:bg-surface-800/50">
            <td
              [attr.colspan]="selectedColumns().length"
              class="!p-2 border-b border-surface-200 dark:border-surface-700"
            >
              <div class="flex items-center gap-2">
                <p-button
                  [icon]="
                    isGroupExpanded(getCellValue(row, 'Data'))
                      ? 'pi pi-chevron-down'
                      : 'pi pi-chevron-right'
                  "
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  (click)="toggleGroup(getCellValue(row, 'Data'))"
                  styleClass="w-8 h-8"
                />
                <span class="font-bold text-surface-900 dark:text-surface-0">
                  {{ formatDateBR(getCellValue(row, 'Data')) }}
                </span>
                <p-tag
                  [value]="calculateDateTotal(getCellValue(row, 'Data')) + ' transações'"
                  severity="secondary"
                  [rounded]="true"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <!-- Cabeçalho das colunas (th) -->
        <ng-template pTemplate="header" let-columns>
          <tr>
            @for (col of columns; track col.field) {
              <th
                [pSortableColumn]="col.field"
                [style.minWidth]="getColMinWidth(col.field)"
                [style.width]="getColMaxWidth(col.field)"
                [ngClass]="colHeaderClass(col.field)"
                class="bg-surface-50 dark:bg-surface-800"
              >
                <div class="flex items-center gap-1">
                  <span
                    class="truncate"
                    [pTooltip]="col.headerFull"
                    tooltipPosition="top"
                    showDelay="200"
                    hideDelay="0"
                    >{{ col.headerAbbr }}</span
                  >
                  <p-sortIcon [field]="col.field"></p-sortIcon>
                </div>
              </th>
            }
          </tr>
        </ng-template>

        <!-- Corpo das linhas (td) -->
        <ng-template pTemplate="body" let-row let-columns="columns">
          @if (isGroupExpanded(getCellValue(row, 'Data'))) {
            <tr
              class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200 text-xs"
            >
              @for (col of columns; track col.field) {
                <td
                  [pTooltip]="colTooltip(row, col.field)"
                  tooltipPosition="top"
                  [showDelay]="200"
                  [hideDelay]="0"
                  [style.minWidth]="getColMinWidth(col.field)"
                  [style.width]="getColMaxWidth(col.field)"
                  [ngClass]="tdClass(row, col.field)"
                >
                  @if (col.field === 'Hóspede') {
                    <a
                      [href]="reservationUrl(getCellValue(row, 'Código de Confirmação'))"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-primary hover:underline block truncate"
                      [style.maxWidth]="getColMaxWidth(col.field)"
                      >{{ getCellValue(row, col.field) }}
                    </a>
                  } @else if (col.field === 'Tipo') {
                    <span class="block truncate" [style.maxWidth]="getColMaxWidth(col.field)">{{
                      getCellValue(row, col.field)
                    }}</span>
                  } @else if (isDateField(col.field)) {
                    <span class="block truncate" [style.maxWidth]="getColMaxWidth(col.field)">{{
                      formatDateBR(getCellValue(row, col.field))
                    }}</span>
                  } @else if (isDerived(col.field)) {
                    @if (isPessoa(col.field)) {
                      <div class="flex items-center gap-2">
                        <i class="pi pi-user text-surface-400 text-xs"></i>
                        <span class="truncate">{{ renderDerived(row, col.field) }}</span>
                      </div>
                    } @else {
                      <span class="block truncate" [style.maxWidth]="getColMaxWidth(col.field)">{{
                        renderDerived(row, col.field)
                      }}</span>
                    }
                  } @else {
                    <span
                      class="block truncate font-medium"
                      [style.maxWidth]="getColMaxWidth(col.field)"
                      >{{ getCellValue(row, col.field) }}</span
                    >
                  }
                </td>
              }
            </tr>
          }
        </ng-template>
      </p-table>
    </div>

    <!-- Paginador Reutilizável -->
    <app-table-paginator
      [first]="first()"
      [rows]="rowsPerPage()"
      [totalRecords]="visibleRows().length"
      [rowsPerPageOptions]="[10, 20, 50, 100]"
      (onPageChange)="onPageChange($event)"
    />
  </div>
</div>
