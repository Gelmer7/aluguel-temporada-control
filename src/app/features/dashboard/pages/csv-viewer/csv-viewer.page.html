<!-- Container principal da página -->
<div class="h-full flex flex-col p-2 bg-surface-50 dark:bg-surface-950 gap-2 overflow-hidden">
  <!-- Header with Actions -->
  <div
    class="flex-none flex items-center justify-between bg-surface-0 dark:bg-surface-900 p-3 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700"
  >
    <div class="flex items-center gap-3">
      <div
        class="w-10 h-10 rounded-lg bg-primary-50 dark:bg-primary-900/20 flex items-center justify-center"
      >
        <i class="pi pi-table text-primary text-xl"></i>
      </div>
      <div>
        <h1 class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0">
          {{ 'ACTIONS.VIEW_CSV' | translate }}
        </h1>
        <p class="text-surface-500 dark:text-surface-400 text-xs mt-0.5">
          Visualizador de transações do Airbnb
        </p>
      </div>
    </div>

    <div class="flex items-center gap-4 text-sm">
      <div class="flex items-center gap-2">
        <span class="text-surface-600 dark:text-surface-400">Ano</span>
        <p-select
          [options]="years()"
          [ngModel]="selectedYear()"
          (ngModelChange)="onYearChange($event)"
          placeholder="Todos"
          [showClear]="true"
          class="w-32"
          appendTo="body"
        ></p-select>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-surface-600 dark:text-surface-400">Mês</span>
        <p-select
          [options]="months"
          [ngModel]="selectedMonth()"
          (ngModelChange)="onMonthChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos"
          [showClear]="true"
          class="w-40"
          appendTo="body"
        ></p-select>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-surface-600 dark:text-surface-400">Tipo</span>
        <p-select
          [options]="types()"
          [ngModel]="selectedType()"
          (ngModelChange)="onTypeChange($event)"
          placeholder="Todos"
          [showClear]="true"
          class="w-56"
          appendTo="body"
        ></p-select>
      </div>
      <div class="flex items-center gap-2 border-l border-surface-200 dark:border-surface-700 pl-4">
        <span class="text-surface-600 dark:text-surface-400">Esconder Payout</span>
        <p-checkbox
          [ngModel]="hidePayout()"
          (ngModelChange)="onHidePayoutChange($event)"
          binary="true"
        ></p-checkbox>
      </div>
      <p-multiselect
        display="chip"
        [options]="cols()"
        [ngModel]="selectedColumns()"
        (ngModelChange)="onColumnsChange($event)"
        optionLabel="headerFull"
        selectedItemsLabel="{0} colunas"
        [style]="{ 'min-width': '200px' }"
        placeholder="Colunas Visíveis"
        appendTo="body"
      ></p-multiselect>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="flex-none grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
    <!-- Luiza Total -->
    <div
      class="bg-surface-0 dark:bg-surface-900 p-2.5 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex items-center gap-3"
    >
      <div
        class="w-9 h-9 rounded-lg bg-pink-50 dark:bg-pink-900/20 flex items-center justify-center flex-none"
      >
        <i class="pi pi-user text-pink-500 text-base"></i>
      </div>
      <div class="min-w-0">
        <p class="text-[10px] text-surface-500 uppercase font-bold m-0 leading-tight">
          Luiza (Anfitriã)
        </p>
        <p class="text-base font-bold text-surface-900 dark:text-surface-0 m-0 truncate">
          {{ summary().luizaValor | currency : 'BRL' }}
        </p>
      </div>
    </div>

    <!-- Gelmer Total -->
    <div
      class="bg-surface-0 dark:bg-surface-900 p-2.5 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex items-center gap-3"
    >
      <div
        class="w-9 h-9 rounded-lg bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center flex-none"
      >
        <i class="pi pi-user text-blue-500 text-base"></i>
      </div>
      <div class="min-w-0">
        <p class="text-[10px] text-surface-500 uppercase font-bold m-0 leading-tight">
          Gelmer (Coanfitrião)
        </p>
        <p class="text-base font-bold text-surface-900 dark:text-surface-0 m-0 truncate">
          {{ summary().gelmerValor | currency : 'BRL' }}
        </p>
      </div>
    </div>

    <!-- Limpeza Total -->
    <div
      class="bg-surface-0 dark:bg-surface-900 p-2.5 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex items-center gap-3"
    >
      <div
        class="w-9 h-9 rounded-lg bg-green-50 dark:bg-green-900/20 flex items-center justify-center flex-none"
      >
        <i class="pi pi-sparkles text-green-500 text-base"></i>
      </div>
      <div class="min-w-0">
        <p class="text-[10px] text-surface-500 uppercase font-bold m-0 leading-tight">Limpeza</p>
        <p class="text-base font-bold text-surface-900 dark:text-surface-0 m-0 truncate">
          {{ summary().totalLimpeza | currency : 'BRL' }}
        </p>
      </div>
    </div>

    <!-- Noites Total -->
    <div
      class="bg-surface-0 dark:bg-surface-900 p-2.5 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex items-center gap-3"
    >
      <div
        class="w-9 h-9 rounded-lg bg-orange-50 dark:bg-orange-900/20 flex items-center justify-center flex-none"
      >
        <i class="pi pi-moon text-orange-500 text-base"></i>
      </div>
      <div class="min-w-0">
        <p class="text-[10px] text-surface-500 uppercase font-bold m-0 leading-tight">Noites</p>
        <p class="text-base font-bold text-surface-900 dark:text-surface-0 m-0 truncate">
          {{ summary().totalNoites }}
        </p>
      </div>
    </div>
  </div>

  <!-- Área da tabela com scroll -->
  <div class="flex-1 min-h-0 bg-surface-0 dark:bg-surface-900 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 flex flex-col overflow-hidden">
    <!-- Barra de ferramentas superior (caption) -->
    <div
      class="flex-none flex items-center justify-between p-3 border-b border-surface-200 dark:border-surface-700"
    >
      <p-iconfield iconPosition="left" class="w-full max-w-sm">
        <p-inputicon>
          <i class="pi pi-search"></i>
        </p-inputicon>
        <input
          pInputText
          type="text"
          [ngModel]="filterQuery()"
          (ngModelChange)="onFilter($event)"
          placeholder="Pesquisar em todas as colunas..."
          class="w-full"
        />
      </p-iconfield>

      <span class="text-xs text-surface-500 italic">
        Arquivo: assets/airbnb_INICIO__01_2026.csv
      </span>
    </div>

    <div class="flex-1 min-h-0 w-full overflow-hidden flex flex-col">
      <p-table
        #dt
        [columns]="selectedColumns()"
        [value]="pagedRows()"
        [scrollable]="true"
        scrollHeight="flex"
        sortMode="single"
        sortField="Data"
        rowGroupMode="subheader"
        [groupRowsBy]="'Data'"
        rowGroupExpandMode="multiple"
        [globalFilterFields]="headers()"
        [tableStyle]="{ 'min-width': '80rem', 'table-layout': 'fixed' }"
        dataKey="__id"
        [rowTrackBy]="rowTrackBy"
        styleClass="p-datatable-sm h-full flex flex-col"
      >
        <!-- Sub-cabeçalho de grupo (Data) -->
        <ng-template pTemplate="rowgroupheader" let-row>
          <tr class="bg-surface-50 dark:bg-surface-800/50">
            <td [attr.colspan]="selectedColumns().length" class="!p-2 border-b border-surface-200 dark:border-surface-700">
              <div class="flex items-center gap-2">
                <p-button
                  [icon]="isGroupExpanded(getCellValue(row, 'Data')) ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  (click)="toggleGroup(getCellValue(row, 'Data'))"
                  styleClass="w-8 h-8"
                />
                <span class="font-bold text-surface-900 dark:text-surface-0">
                  {{ formatDateBR(getCellValue(row, 'Data')) }}
                </span>
                <p-tag
                  [value]="calculateDateTotal(getCellValue(row, 'Data')) + ' transações'"
                  severity="secondary"
                  [rounded]="true"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <!-- Cabeçalho das colunas (th) -->
        <ng-template pTemplate="header" let-columns>
          <tr>
            @for (col of columns; track col.field) {
            <th
              [pSortableColumn]="col.field"
              [style.minWidth]="getColMinWidth(col.field)"
              [style.width]="getColMaxWidth(col.field)"
              [ngClass]="colHeaderClass(col.field)"
              class="bg-surface-50 dark:bg-surface-800"
            >
              <div class="flex items-center gap-1">
                <span
                  class="truncate"
                  [pTooltip]="col.headerFull"
                  tooltipPosition="top"
                  showDelay="200"
                  hideDelay="0"
                  >{{ col.headerAbbr }}</span
                >
                <p-sortIcon [field]="col.field"></p-sortIcon>
              </div>
            </th>
            }
          </tr>
        </ng-template>

        <!-- Corpo das linhas (td) -->
        <ng-template pTemplate="body" let-row let-columns="columns">
          @if (isGroupExpanded(getCellValue(row, 'Data'))) {
          <tr
            class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200 text-xs"
          >
            @for (col of columns; track col.field) {
            <td
              [pTooltip]="colTooltip(row, col.field)"
              tooltipPosition="top"
              [showDelay]="200"
              [hideDelay]="0"
              [style.minWidth]="getColMinWidth(col.field)"
              [style.width]="getColMaxWidth(col.field)"
              [ngClass]="tdClass(row, col.field)"
            >
              @if (col.field === 'Hóspede') {
              <a
                [href]="reservationUrl(getCellValue(row, 'Código de Confirmação'))"
                target="_blank"
                rel="noopener noreferrer"
                class="text-primary hover:underline block truncate"
                [style.maxWidth]="getColMaxWidth(col.field)"
                >{{ getCellValue(row, col.field) }}
              </a>
              } @else if (col.field === 'Tipo') {
              <span class="block truncate" [style.maxWidth]="getColMaxWidth(col.field)">{{
                getCellValue(row, col.field)
              }}</span>
              } @else if (isDateField(col.field)) {
              <span class="block truncate" [style.maxWidth]="getColMaxWidth(col.field)">{{
                formatDateBR(getCellValue(row, col.field))
              }}</span>
              } @else if (isDerived(col.field)) { @if (isPessoa(col.field)) {
              <div class="flex items-center gap-2">
                <i class="pi pi-user text-surface-400 text-xs"></i>
                <span class="truncate">{{ renderDerived(row, col.field) }}</span>
              </div>
              } @else {
              <span class="block truncate" [style.maxWidth]="getColMaxWidth(col.field)">{{
                renderDerived(row, col.field)
              }}</span>
              } } @else {
              <span class="block truncate font-medium" [style.maxWidth]="getColMaxWidth(col.field)">{{
                getCellValue(row, col.field)
              }}</span>
              }
            </td>
            }
          </tr>
          }
        </ng-template>
      </p-table>
    </div>

    <!-- Paginador Reutilizável -->
    <app-table-paginator
      [first]="first()"
      [rows]="rowsPerPage()"
      [totalRecords]="visibleRows().length"
      [rowsPerPageOptions]="[10, 20, 50, 100]"
      (onPageChange)="onPageChange($event)"
    />
  </div>
</div>

