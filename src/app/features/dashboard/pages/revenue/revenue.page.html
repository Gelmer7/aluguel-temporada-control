<div class="flex flex-col h-full overflow-hidden p-2 gap-2">
  <p-toast />

  <ng-template #headerActions>
    <div class="flex items-center gap-2">
      <p-button
        icon="pi pi-file-pdf"
        severity="secondary"
        (click)="onDownloadPDF()"
        [pTooltip]="'TITHE_MANAGEMENT.DOWNLOAD_PDF' | translate"
        tooltipPosition="left"
        [size]="'small'"
      />
    </div>
  </ng-template>

  <!-- Filtros -->
  <div class="flex flex-col gap-2">
    <app-filter-container>
      <ng-template #filterSummary class="flex flex-wrap items-center gap-2">
        <span
          >{{ 'TERMS.YEAR' | translate }}:
          <span>
            @if (selectedYear() === 'ALL') {
              {{ 'TERMS.ALL' | translate }}
            } @else {
              {{ selectedYear() }}
            }
          </span></span
        >
        <span
          >{{ 'TERMS.MONTH' | translate }}:
          <span>
            @if (selectedMonths().length === 0) {
              {{ 'TERMS.ALL' | translate }}
            } @else {
              {{ selectedMonths().length }} {{ 'TERMS.SELECTED' | translate }}
            }
          </span></span
        >
        @if (selectedTypes().length > 0) {
          <span
            >{{ 'TERMS.TYPE' | translate }}:
            <span>
              @if (selectedTypes().length === availableTypes().length) {
                {{ 'TERMS.ALL' | translate }}
              } @else {
                {{ selectedTypes().join(', ') }}
              }
            </span></span
          >
        }
      </ng-template>

      <div class="flex flex-wrap items-center gap-2 w-full p-1">
        <!-- ano -->
        <p-floatLabel class="flex-1 min-w-[120px]" variant="in">
          <p-select
            [options]="yearOptions()"
            [(ngModel)]="selectedYear"
            optionLabel="label"
            optionValue="value"
            [fluid]="true"
            appendTo="body"
          >
            <ng-template pTemplate="selectedItem" let-selectedOption>
              {{ selectedOption.label | translate }}
            </ng-template>
            <ng-template pTemplate="item" let-option>
              {{ option.label | translate }}
            </ng-template>
          </p-select>
          <label>{{ 'TERMS.YEAR' | translate }}</label>
        </p-floatLabel>

        <!-- mes -->
        <p-floatLabel class="flex-1 min-w-[150px]" variant="in">
          <p-multiselect
            [options]="monthOptions()"
            [(ngModel)]="selectedMonths"
            optionLabel="label"
            optionValue="value"
            [fluid]="true"
            [maxSelectedLabels]="2"
            appendTo="body"
          >
            <ng-template pTemplate="selectedItems" let-selectedOptions>
              @if (selectedOptions && selectedOptions.length > 0) {
                {{ selectedOptions.length }} {{ 'TERMS.SELECTED' | translate }}
              } @else {
                {{ 'TERMS.ALL' | translate }}
              }
            </ng-template>
            <ng-template pTemplate="item" let-option>
              {{ option.label | translate }}
            </ng-template>
          </p-multiselect>
          <label>{{ 'TERMS.MONTH' | translate }}</label>
        </p-floatLabel>

        <!-- tipo -->
        <p-floatLabel class="flex-1 min-w-[150px]" variant="in">
          <p-multiselect
            [options]="availableTypes()"
            [(ngModel)]="selectedTypes"
            optionLabel="label"
            optionValue="value"
            [fluid]="true"
            [maxSelectedLabels]="2"
            appendTo="body"
          >
            <ng-template pTemplate="item" let-option>
              {{ option.label | translate }}
            </ng-template>
          </p-multiselect>
          <label>{{ 'TERMS.TYPE' | translate }}</label>
        </p-floatLabel>

        <!-- periodo -->
        <div class="flex items-center self-center h-full">
          <p-button
            icon="pi pi-calendar"
            [rounded]="true"
            [text]="true"
            (click)="op_date_filter.toggle($event)"
            [pTooltip]="'TERMS.FILTER_BY_PERIOD' | translate"
            tooltipPosition="top"
            [severity]="filterDateRange() ? 'primary' : 'secondary'"
            [styleClass]="
              filterDateRange()
                ? 'shadow-[0_0_10px_rgba(var(--p-primary-500-rgb),0.4)] bg-primary/10'
                : ''
            "
          >
            @if (filterDateRange()) {
              <span
                class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-primary text-[10px] text-white animate-pulse"
              >
                !
              </span>
            }
          </p-button>

          <p-popover #op_date_filter>
            <div class="p-3 flex flex-col gap-3 min-w-[280px]">
              <div
                class="flex items-center justify-between border-b border-surface-200 dark:border-surface-700 pb-2"
              >
                <span class="text-sm font-semibold text-surface-700 dark:text-surface-100">{{
                  'TERMS.SELECT_PERIOD' | translate
                }}</span>
                @if (filterDateRange()) {
                  <p-button
                    icon="pi pi-trash"
                    [text]="true"
                    severity="danger"
                    size="small"
                    (click)="onDateRangeChange(null); op_date_filter.hide()"
                    [pTooltip]="'ACTIONS.CLEAR_FILTER' | translate"
                  />
                }
              </div>
              <div class="flex flex-col gap-1">
                <label for="popover_range_date" class="text-xs text-surface-500 mb-1">{{
                  'TERMS.DATE_RANGE' | translate
                }}</label>
                <p-datepicker
                  inputId="popover_range_date"
                  [ngModel]="filterDateRange()"
                  (ngModelChange)="onDateRangeChange($event)"
                  selectionMode="range"
                  [showIcon]="true"
                  [showClear]="false"
                  [readonlyInput]="false"
                  class="w-full"
                  appendTo="body"
                  [dateFormat]="'PRIMENG.dateFormat' | translate"
                  [placeholder]="'PRIMENG.dateFormat' | translate"
                  styleClass="w-full"
                ></p-datepicker>
              </div>
              <div class="text-[10px] text-surface-400 italic">
                {{ 'TERMS.DATE_PICKER_HINT' | translate }}
              </div>
            </div>
          </p-popover>
        </div>

        <!-- ações -->
        <p-button
          icon="pi pi-filter-slash"
          [outlined]="true"
          (click)="clearFilters()"
          [pTooltip]="'ACTIONS.CLEAR_FILTERS' | translate"
          tooltipPosition="bottom"
        />
      </div>
    </app-filter-container>
  </div>

  <div class="flex-1 flex flex-col gap-4 overflow-y-auto">
    <!-- Tabela de Receitas -->
    <div class="rounded-xl shadow-sm border flex flex-col p-1">
      <div
        class="flex items-center justify-between p-2 border-b border-surface-200 dark:border-surface-700 bg-surface-50/50 dark:bg-surface-800/50"
      >
        <span>{{ 'TITHE_MANAGEMENT.PAYMENTS_LIST' | translate }}</span>
        <i
          class="pi pi-chart-line cursor-pointer hover:text-primary transition-colors"
          (click)="showChart.set(true)"
          [pTooltip]="'TERMS.CHARTS' | translate"
          tooltipPosition="left"
        ></i>
      </div>
      <div class="flex-1 w-full overflow-auto flex flex-col">
        <p-table
          [value]="filteredPayments()"
          [rows]="10"
          [paginator]="true"
          [loading]="loading()"
          [scrollable]="true"
          class="p-datatable-sm"
          [tableStyle]="{ 'min-width': '1000px' }"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'EXPENSES_FORM.DATE' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.GUEST' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'TERMS.CONFIRMATION_CODE' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'TERMS.HOUSE_CODE' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.TYPE' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">
                {{ 'TERMS.START_DATE' | translate }}
              </th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.END_DATE' | translate }}</th>
              <th class="bg-surface-50 dark:bg-surface-800">{{ 'TERMS.PAID' | translate }}</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-payment>
            <tr
              class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors duration-200"
            >
              <td class="truncate">{{ payment.data | date: 'dd/MM/yy' }}</td>
              <td class="truncate">{{ payment.hospede }}</td>
              <td class="truncate">{{ payment.codigo_confirmacao }}</td>
              <td class="truncate">{{ payment.house_code }}</td>
              <td class="truncate">{{ payment.tipo }}</td>
              <td class="truncate">{{ payment.data_inicio | date: 'dd/MM/yy' }}</td>
              <td class="truncate">{{ payment.data_termino | date: 'dd/MM/yy' }}</td>
              <td class="truncate">{{ payment.pago | currency: 'BRL' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="7" class="text-right bg-surface-50/50 dark:bg-surface-800/50">Total:</td>
              <td class="bg-surface-50/50 dark:bg-surface-800/50">
                {{ totalReceived() | currency: 'BRL' }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>

<app-earnings-payments-charts [(visible)]="showChart" [payments]="filteredPayments()" />
